<!doctype html>
<html lang="en">
  <head>
    <title>Communal API Reference</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="API documentation for the Communal platform" />
    <link rel="icon" type="image/svg+xml" href="/logo-icon.svg" />
    <style>
      body {
        margin: 0;
      }

      .custom-header {
        display: flex;
        align-items: center;
        padding: 12px 18px;
        border-bottom: 1px solid var(--scalar-border-color, #e1e1e1);
        background: var(--scalar-background-1, #fff);
      }

      .custom-header img {
        height: 28px;
        width: auto;
      }

      /* Hide the dark logo by default, show the light one */
      .custom-header .logo-dark {
        display: none;
      }

      /* In dark mode, swap logos */
      .dark-mode .custom-header .logo-light,
      [class*="dark"] .custom-header .logo-light {
        display: none;
      }
      .dark-mode .custom-header .logo-dark,
      [class*="dark"] .custom-header .logo-dark {
        display: block;
      }

      /* Per-endpoint LLM buttons â€” inline with heading */
      .llm-actions {
        display: inline-flex;
        gap: 4px;
        margin-left: 30px;
        vertical-align: middle;
      }

      .llm-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        border: 1px solid var(--scalar-border-color, #e1e1e1);
        border-radius: 5px;
        background: var(--scalar-background-1, #fff);
        color: var(--scalar-color-3, #8e8e8e);
        font-size: 11px;
        font-family: inherit;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
        line-height: 1;
        transition: all 0.15s ease;
      }

      .llm-btn:hover {
        background: var(--scalar-background-2, #f5f5f5);
        color: var(--scalar-color-1, #1a1a1a);
        border-color: var(--scalar-color-3, #8e8e8e);
      }

      .llm-btn svg {
        width: 12px;
        height: 12px;
        flex-shrink: 0;
      }

      .llm-btn.copied {
        color: #16a34a;
        border-color: #16a34a;
      }
    </style>
  </head>
  <body>
    <div class="custom-header">
      <img src="/logo.svg" alt="Communal" class="logo-light" />
      <img src="/logo-dark.svg" alt="Communal" class="logo-dark" />
    </div>
    <script
      id="api-reference"
      data-url="https://communal-api.s3.ca-central-1.amazonaws.com/docs/api.json"
      data-proxy-url="https://proxy.scalar.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@scalar/api-reference"></script>
    <script>
      const COPY_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>'
      const CHECK_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>'
      const MD_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>'

      function copyEndpointMarkdown(btn, key) {
        if (!window.__endpointMarkdown) return
        const md = window.__endpointMarkdown[key]
        if (!md) return
        navigator.clipboard.writeText(md)
        btn.innerHTML = CHECK_ICON + 'Copied'
        btn.classList.add('copied')
        setTimeout(() => {
          btn.innerHTML = COPY_ICON + 'Copy for LLM'
          btn.classList.remove('copied')
        }, 2000)
      }

      function viewEndpointMarkdown(key) {
        if (!window.__endpointMarkdown) return
        const md = window.__endpointMarkdown[key]
        if (!md) return
        const blob = new Blob([md], { type: 'text/plain' })
        window.open(URL.createObjectURL(blob), '_blank')
      }

      // Load per-endpoint markdown and summary-to-key map (both generated at build time)
      Promise.all([
        fetch('/llms-endpoints.json').then(r => r.json()),
        fetch('/llms-summary-map.json').then(r => r.json()),
      ]).then(([endpoints, summaryToKey]) => {
        window.__endpointMarkdown = endpoints

        function escapeAttr(str) {
          return str.replace(/'/g, "\\'").replace(/"/g, '&quot;')
        }

        function injectButtons() {
          // Scalar renders: .section-header > [Anchor] > h3 (with operation summary text)
          // Target h3 inside .section-header, plus fallback selectors
          const headings = document.querySelectorAll(
            '.section-header h3, .section-header h2, .section-header-wrapper h3, .section-header-wrapper h2'
          )

          headings.forEach(heading => {
            // Skip if already injected
            if (heading.closest('.section-header-wrapper')?.querySelector('.llm-actions')) return
            if (heading.querySelector('.llm-actions')) return

            // Get text, stripping any nested element text we may have added
            const text = heading.childNodes[0]?.textContent?.trim() || heading.textContent.trim()
            const key = summaryToKey[text]
            if (!key || !endpoints[key]) return

            const escaped = escapeAttr(key)
            const actions = document.createElement('span')
            actions.className = 'llm-actions'
            actions.innerHTML =
              `<button class="llm-btn" onclick="event.stopPropagation(); viewEndpointMarkdown('${escaped}')" title="View as Markdown">${MD_ICON}Markdown</button>` +
              `<button class="llm-btn" onclick="event.stopPropagation(); copyEndpointMarkdown(this, '${escaped}')" title="Copy for LLM">${COPY_ICON}Copy for LLM</button>`

            // Append to the section-header div (sibling to heading) for better layout
            const sectionHeader = heading.closest('.section-header') || heading.closest('.section-header-wrapper')
            if (sectionHeader) {
              sectionHeader.appendChild(actions)
            } else {
              heading.appendChild(actions)
            }
          })
        }

        const observer = new MutationObserver(() => injectButtons())
        observer.observe(document.body, { childList: true, subtree: true })
        injectButtons()
        setTimeout(injectButtons, 3000)
        setTimeout(injectButtons, 6000)
      })
    </script>
  </body>
</html>
